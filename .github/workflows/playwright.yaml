name: Playwright Tests
on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-node@v4
      with:
        node-version: 18


    # 1.1. Instalação de dependências do Playwright Project
    - name: Install Playwright Project Dependencies
      run: npm install -g yarn && yarn
      working-directory: ./playwright-mark

    # 1.2. Instalação de dependências do Backend (./apps/api)
    # Tente adicionar um nível extra que o runner pode estar esperando, baseado no log de erro.
    - name: Install API Dependencies
      run: yarn
      working-directory: ./playwright_express/apps/api # <--- REVERTENDO O CAMINHO COM O PREFIXO

    # 1.3. Instalação de dependências do Frontend (./apps/web)
    - name: Install Web Dependencies
      run: yarn
      working-directory: ./playwright_express/apps/web # <--- REVERTENDO O CAMINHO COM O PREFIXO

    - name: Start Application Services (Web:3000 & API:3333)
      run: |
        # Inicia o Backend (API) em background
        echo "Starting API Service..."
        yarn dev &
        
        # Inicia o Frontend (Web) em background
        echo "Starting Web Service..."
        (cd ../web && yarn dev) &
        
      working-directory: ./playwright_express/apps/api # <--- REVERTENDO O CAMINHO COM O PREFIXO


    # 1.4. Instalação do 'wait-on' no projeto Playwright
    - name: Install wait-on in Playwright Project
      run: yarn add wait-on
      working-directory: ./playwright-mark

    # --- 2. Início dos Serviços ---

    - name: Start Application Services (Web:3000 & API:3333)
      run: |
        # Inicia o Backend (API) em background
        echo "Starting API Service..."
        yarn dev &
        
        # Inicia o Frontend (Web) em background
        echo "Starting Web Service..."
        (cd ../web && yarn dev) &
        
      working-directory: ./apps/api # <--- APENAS apps/api

    - name: Wait for Services to be Ready
      run: |
        ./node_modules/.bin/wait-on http://localhost:3000 http://localhost:3333 -t 120000
      working-directory: ./playwright-mark

    # --- 3. Execução dos Testes ---

    - name: Install Playwright Browsers
      run: yarn playwright install --with-deps
      working-directory: ./playwright-mark

    - name: Run Playwright tests
      run: yarn playwright test
      working-directory: ./playwright-mark
      
    - uses: actions/upload-artifact@v4
      if: ${{ !cancelled() }}
      with:
        name: playwright-report
        path: playwright-mark/playwright-report/
        retention-days: 30