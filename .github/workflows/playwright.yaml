name: Playwright Tests
on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4 # 1. Checa o código (na raiz)

    - uses: actions/setup-node@v4
      with:
        node-version: 18

    # --- 1. Instalação de Dependências ---

    # 1.1. Instalação de dependências do Playwright Project (./playwright-mark)
    - name: Install Playwright Project Dependencies
      run: npm install -g yarn && yarn
      working-directory: ./playwright-mark

    # 1.2. Instalação de dependências do Backend (./playwright_express/apps/api)
    - name: Install API Dependencies
      run: yarn
      working-directory: ./playwright_express/apps/api

    # 1.3. Instalação de dependências do Frontend (./playwright_express/apps/web)
    - name: Install Web Dependencies
      run: yarn
      working-directory: ./playwright_express/apps/web

    # 1.4. Instalação do 'wait-on' no projeto Playwright (para ser facilmente acessível)
    - name: Install wait-on in Playwright Project
      run: yarn add wait-on
      working-directory: ./playwright-mark

    # --- 2. Início dos Serviços ---

    - name: Start Application Services (Web:3000 & API:3333)
      run: |
        # Inicia o Backend (API) em background
        echo "Starting API Service..."
        yarn dev &
        
        # Inicia o Frontend (Web) em background
        echo "Starting Web Service..."
        (cd ../web && yarn dev) &
        
        # O comando 'wait' impede que o step termine imediatamente, garantindo que
        # os processos em background continuem rodando.
        # No entanto, eles já são mantidos vivos pelo `&`. A próxima etapa de `wait-on`
        # garante que o workflow não avance antes dos servidores estarem prontos.
      working-directory: ./playwright_express/apps/api # Começa na pasta da API e usa cd ../web para a Web

    - name: Wait for Services to be Ready
      run: |
        # Espera que ambas as portas estejam ativas antes de iniciar os testes
        # Note o caminho ajustado para o wait-on dentro da pasta do projeto de testes
        ./node_modules/.bin/wait-on http://localhost:3000 http://localhost:3333 -t 120000 # Aumentei o timeout para 2 minutos (120000ms)
      working-directory: ./playwright-mark # Garante que o wait-on seja executado de onde foi instalado

    # --- 3. Execução dos Testes ---

    - name: Install Playwright Browsers
      run: yarn playwright install --with-deps
      working-directory: ./playwright-mark

    - name: Run Playwright tests
      run: yarn playwright test
      working-directory: ./playwright-mark
      
    - uses: actions/upload-artifact@v4
      if: ${{ !cancelled() }}
      with:
        name: playwright-report
        path: playwright-mark/playwright-report/
        retention-days: 30